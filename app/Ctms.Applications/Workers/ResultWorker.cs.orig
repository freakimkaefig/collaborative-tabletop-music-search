using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using MusicSearch.Objects;
using Ctms.Applications.DataFactories;
using Ctms.Domain.Objects;
using Ctms.Applications.ViewModels;
using System.ComponentModel.Composition;
using Ctms.Applications.DataModels;
using SpotifySharp;
using MusicStream;
using System.Collections.ObjectModel;
using Helpers;
using Ctms.Applications.DevHelper;
using Ctms.Applications.Common;

namespace Ctms.Applications.Workers
{
    [Export]
    public class ResultWorker
    {
        private ResultViewModel _resultViewModel;
        private MenuViewModel _menuViewModel;
        private MusicStreamAccountWorker _accountWorker;
        private InfoWorker _infoWorker;
        private MusicStreamSessionManager _sessionManager;
        private MusicStreamVisualizationManager _visualizationManager;
        //private FftWorker _fftWorker;

        [ImportingConstructor]
        public ResultWorker(ResultViewModel resultViewModel, MenuViewModel menuViewModel, MusicStreamAccountWorker accountWorker,
            InfoWorker infoWorker)
        {

            _resultViewModel = resultViewModel;
            _menuViewModel = menuViewModel;
            _accountWorker = accountWorker;
            _infoWorker = infoWorker;
            //_fftWorker = fftWorker;
            _accountWorker.ResultSessionManagerCreated = ResultSessionManagerCreated;
            //_fftWorker.VisualizationManagerCreated = VisualizationManagerCreated;
        }

        private void ResultSessionManagerCreated(MusicStreamSessionManager sessionManager)
        {
            _sessionManager = sessionManager;
        }

        private void VisualizationManagerCreated(MusicStreamVisualizationManager visualizationManager)
        {
            _visualizationManager = visualizationManager;
            _sessionManager.VisualizationManager = _visualizationManager;
        }

        public bool CanRefreshResults() { return _resultViewModel.IsValid; }

        public void RefreshResults(List<ResponseContainer.ResponseObj.Song> songs)
        {
            if (songs != null)
            {
                if (_menuViewModel.IsLoggedIn)
                {
                    _resultViewModel.Results.Clear();
                    foreach (var song in songs)
<<<<<<< HEAD
                    {
                        //DevLogger.Log("ResultWorker:63 - " + response[i].ToString());
                        if (_resultViewModel.Results.Count < CommonVal.Results_MaxNumber)
=======
                    {                        
                        if (_resultViewModel.Results.Count < 20)
>>>>>>> c7db43c7e8b5b928163d961a4d2170da5ac91b10
                        {
                            foreach (var track in song.tracks)
                            {
                                if (_sessionManager.CheckTrackAvailability(track.foreign_id) != null)
                                {
                                    //remove unwanted chars/expressions
                                    String name = StringHelper.cleanText(song.Artist_Name);
                                    String title = StringHelper.cleanText(song.Title);

                                    _resultViewModel.Results.Add(new ResultDataModel(title, name, _sessionManager.CheckTrackAvailability(track.foreign_id)));
                                    ResultDataModel result = _resultViewModel.Results.Last();
                                    result.OriginIds = song.originIDs;

                                    result.OriginColors = new ObservableCollection<string>();
                                    result.Result.Song.ArtistId = song.Artist_Id;
                                    result.Result.Response = song;
                                    foreach (var originId in response[i].originIDs)
                                    {
                                        result.OriginColors.Add(CommonVal.TagColors[originId]);
                                    }
                                }
                            }
                        }
                        else
                        {
                            return;
                        }
                    }

                    if (_resultViewModel.Results.Count < 5)
                    {
                        //search again
                        //!!ToDo
                    }
                }
                else
                {
                    _menuViewModel.DisplayLoginDialog(true);
                    //_infoWorker
                }
            }
        }

        public void RefreshDetails(List<ResponseContainer.ResponseObj.ArtistInfo> response, ResultDataModel result)
        {
            if (response != null)
            {
                if (response.Count > 0)
                {
                    var r = response[0];
                    Detail d = new Detail();

                    //About
                    d.Name = r.name;

                    foreach (var biography in r.biographies)
                    {
                        if (biography.text.Length > 500)
                        {
                            d.Biography = StringHelper.cleanText(biography.text);
                            break;
                        }
                    }

                    d.City = r.artist_location[0].location;

                    d.Image = new ArtistImage();
                    d.Image.ImageUrl = r.images[0].url;

                    if (r.terms != null)
                    {
                        d.Genres = new List<String>();
                        for (var i = 0; i < r.terms.Count; i++)
                        {
                            d.Genres.Add(r.terms[i].name);
                            if (i == 3) break;
                        }
                    }

                    //News
                    d.News = new ObservableCollection<ArtistNews>();
                    foreach (var news in r.news)
                    {
                        ArtistNews newsEntry = new ArtistNews();
                        newsEntry.Title = StringHelper.cleanText(news.name);
                        newsEntry.Summary = StringHelper.cleanText(news.summary);
                        newsEntry.Url = news.url;
                        d.News.Add(newsEntry);
                    }

                    //Media
                    d.Images = new ObservableCollection<ArtistImage>();
                    foreach (var images in r.images)
                    {
                        ArtistImage image = new ArtistImage();
                        image.ImageUrl = images.url;
                        d.Images.Add(image);
                    }
                    d.Videos = new ObservableCollection<ArtistVideo>();
                    foreach (var videos in r.video)
                    {
                        ArtistVideo video = new ArtistVideo();
                        video.Title = StringHelper.cleanText(videos.title);
                        video.VideoUrl = videos.url;
                        video.PreviewUrl = videos.image_url;
                        d.Videos.Add(video);
                    }

                    //Reviews
                    d.Reviews = new ObservableCollection<ArtistReview>();
                    foreach (var reviews in r.reviews)
                    {
                        ArtistReview review = new ArtistReview();
                        review.Name = StringHelper.cleanText(reviews.name);
                        review.Release = StringHelper.cleanText(reviews.release);
                        review.Summary = StringHelper.cleanText(reviews.summary);
                        review.Url = reviews.url;
                        d.Reviews.Add(review);
                    }

                    //Songs
                    d.Songs = new ObservableCollection<ArtistSong>();
                    foreach (var songs in r.ArtistSongs)
                    {
                        ArtistSong song = new ArtistSong();
                        song.Title = StringHelper.cleanText(songs.title);
                        song.TrackId = songs.title_id;
                        d.Songs.Add(song);
                    }

                    result.Detail = d;
                    result.IsDetailLoading = false;
                    result.IsDetailLoaded = true;
                }
            }
        }

        public void PrelistenFromDetailView(String spotifyTrackId)
        {
             
        }
    }
}